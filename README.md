# Infrastructure Code

This repo contains common infrastructure code and configuration that
is used in multiple components, including:

 * Ansible tasks which are be shared between applications.
 * Global terraform setup

## Terraform


    aws_access_key="ABCDEABCDEABCDEABC"
    aws_secret_key="jsldfkjf6868HKHybkjdfdfdkjfk7878dfhj"

The output of terraform is stored in `.tfstate` files inside the state
directory.

There are top-level scripts that tie all of this together pointing to
the correct files for a given environment. These are named
`tf-<environment>`. See `tf-sandbox` for example.

### Running

You will need to download and install terraform on your system.

**NOTE:** You should use the version which is currently in use, not a
newer version, when making any changes.  This is because the version
is written into the state file and terraform will refuse to use state
files from future versions.

To see what updates are needed run:

    tf-<environment> plan

To apply those updates:

    tf-<environment> apply


### Networking

Each environment has its own VPC. There is a separate VPC for Jenkins.

Special security groups:

 * **default_sandbox** - each environment has a shared security group
   permitting all traffic between instances which have this security
   group.
   
 * **allow_office_access** - configured with IPs of offices/staff
   giving full access via the instance public addresses.
   
 * **jenkins_access_sandbox** - not used, needs to be deleted.

 * **jenkins_access** - this is actually created by the jenkins
   terraform scripts and permits SSH access coming from the public IP
   of the jenkins master.

DNS entries have the format:

 * *SERVICE*-*N*-int.*ENVIRONMENT*.emeraldnorthstar.com. VPC subnet IP of *n*th service instance.
 * *SERVICE*-*N*.*ENVIRONMENT*.emeraldnorthstar.com. Public IP of service *n*th service instance.
 * *SERVICE*.*ENVIRONMENT*.emeraldnorthstar.com. Round-robin DNS or load balancer IP for service.


## Ansible

To use the ansible roles from this repository, put the following into
`requirements.yml` and install with
`ansible-galaxy install -r requirements.yml --roles-path .`

    - src: git@bitbucket.org:emeraldgroup/pp_infrastructure.git
      name: shared-roles
      scm: git

## Additional steps for manual configuration of Jenkins

We need NPM installed so we can build the autogenerated files on Jenkins:

    curl --silent --location https://rpm.nodesource.com/setup_8.x | bash -
    yum -y install nodejs
